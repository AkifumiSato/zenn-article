---
title: "Recoilはグローバル状態管理ライブラリなのか？"
emoji: "🍣"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["react", "recoil"]
published: false
---

グローバルな状態管理ライブラリを指してRecoilやReduxが並列に語られていることに違和感があったので、自分なりに考えをまとめてみました。

## 従来のグローバルな状態管理

Reactが人気を博したころ、ReduxはReactのグローバルな状態管理ライブラリとしてよく採用されました。ReduxはReactに依存してないので、Redux単体や他のViewライブラリでも採用は可能でしたが、おそらく多くの方はReactとセットで利用されてたものと思われます。React×Reduxのセットは、フロントエンドに一貫した設計を設けることができるため、強い人気を得ました。

この頃は、UIから状態管理を分けることが多くのエンジニアの関心ごとだったと考えられます。jQueryなどをベースに実装している場合、設計指針が統率しづらかったので、ReactとReduxを導入することで単方向データフローに統一することができるというのが大きな魅力だったようにも感じます。

Reactが大きな人気を得て、状態を分離するということから徐々に用途に応じた状態管理へと人気は映っていきます。

## Recoil

[Recoil](https://recoiljs.org/)とは、Metaが作っているReactのグローバルな状態管理ライブラリです。2020年に登場し、現在でもexperimentalながら一定の人気を得ているライブラリです。Reduxと大きく異なる点として、code splittingが効くのでページ単位でのバンドルサイズを減らすことが大きな注目点でした。また、`useState`に近いAPIにより、Reduxよりより直感的な利用が可能でした。

## グローバルな状態管理とは

ここで「グローバルな状態管理」という言葉にまとめてしまいましたが、ReduxとRecoilは並列に語れるものなのでしょうか？「グローバル」の解像度をもう少し上げてみましょう。

「グローバルな状態管理」には、以下2つの意味合いが混在していると筆者は考えています。

- **参照スコープ**
- **ライフタイムスコープ**

これらについては以前書いた記事でも述べています。

https://zenn.dev/akfm/articles/react-state-scope#%E3%83%A9%E3%82%A4%E3%83%95%E3%82%BF%E3%82%A4%E3%83%A0%E3%81%AB%E3%82%88%E3%82%8Bstate%E3%81%AE%E5%88%86%E9%A1%9E

Reduxは上記2つの意味においてグローバルですが、Recoilは前者に対しては必ずしもグローバルとは限りません。言い換えると、recoilの状態は必ずしも`export`せずとも利用することができます。

```tsx
const todoListState = atom({
  key: 'TodoList',
  default: [],
});

function TodoList() {
  const todoList = useRecoilValue(todoListState);

  return (
    <>
      {/* <TodoListStats /> */}
      {/* <TodoListFilters /> */}
      <TodoItemCreator />

      {todoList.map((todoItem) => (
              <TodoItem key={todoItem.id} item={todoItem} />
      ))}
    </>
  );
}
```

上記例はページ内で複数利用があまり想定されていない例ですが、SPAであればこの場合、`useState`と異なりコンポーネントのアンマウント後も`todoListState`の値を保持することができます。

一方で`TodoList`コンポーネントを複数箇所で利用する場合、`todoListState`は共有された状態となりますが`atomFamily`などを利用すればコンポーネント単位で独立した状態管理をすることが可能です。

そして何よりこの場合、`todoListState`は`export`してないので**他ファイルで利用されることがありません**。RecoilがReduxと大きく異なるのは、利用者をこうして制限することができる点です。もちろん命名やState構造の設計次第で利用者を限定するようなことはよくあると思いますが、それを意識して運用することと仕組みでもって運用するのでは大きく意味が違います。

このことからわかるように、Recoilは必ずしも参照スコープ的にグローバルとは限りません。ReduxでやれることはおおよそRecoilでも可能ですが、参照スコープをグローバルでなくすのはRecoilでなくてはできません。「グローバルな状態管理」という言葉はおおよそ参照スコープを指していることが多いように感じますが、Recoilは実は必ずしもグローバルな参照スコープを扱うライブラリではないと考えられます。

## 構成

- ライフタイムの延長
  - Reduxとかでももちろん可能だが、ライフタイムを延長することができる
  - recoil sync使うと楽

