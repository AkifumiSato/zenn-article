_---
title: "Next.jsã¯ã©ã†ã‚„ã£ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒã™ã‚‹ã®ã‹"
emoji: "ğŸ“œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextjs"]
published: false
---

[Next.js](https://nextjs.org/)ã«ã¯experimental(å®Ÿé¨“çš„æ©Ÿèƒ½)ã§`scrollRestoration`ã¨ã„ã†ãƒ•ãƒ©ã‚°ãŒå­˜åœ¨ã—ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚‚ãƒ–ãƒ©ã‚¦ã‚¶å´ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒã—ã¦ãã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ãŒã€Safariã§ã¯å¾©å…ƒã•ã‚Œãªã‹ã£ãŸã‚Šã€Chromeã§ã‚‚`getServerSideProps`åˆ©ç”¨æ™‚ã«ã¯ã“ã®ãƒ•ãƒ©ã‚°ã‚’æœ‰åŠ¹ã«ã—ãªã„ã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ãŒå¾©å…ƒã•ã‚Œãªã„ãªã©ä¸å®‰å®šãªçŠ¶æ…‹ã§ã™ã€‚æœ€è¿‘ã“ã®è¾ºã‚Šã«ã¤ã„ã¦è­˜è€…ã®æ–¹ã€…ã‹ã‚‰è‰²ã€…ã”æ•™ç¤ºã„ãŸã ãã€è‡ªåˆ†ã§ã¯æ°—ä»˜ã‘ãªã„ã‚ˆã†ãªéƒ¨åˆ†ã®çŸ¥è¦‹ã‚‚å¤šãå¾—ã‚‰ã‚ŒãŸã®ã§ã€å‚™å¿˜éŒ²å…¼ã­ã¦`scrollRestoration`ãŒä½•ã‚’è§£æ±ºã—ã‚ˆã†ã¨ã—ã¦ã€ã©ã†å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã®ã‹è§£èª¬ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## Next.jsã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¾©å…ƒæŒ™å‹•

å¤šãã®MPA(Multi Page Application)ã§ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯/ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã‚’è¡Œã£ãŸéš›ã«ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚ˆã£ã¦å¾©å…ƒã•ã‚Œã¾ã™ã€‚ã“ã†ã„ã£ãŸæŒ™å‹•ãŒå„ãƒ–ãƒ©ã‚¦ã‚¶ã«ã„ã¤ã‹ã‚‰ã‚ã‚‹ã®ã‹ã¯æŠŠæ¡ã—ã¦ã„ã¾ã›ã‚“ãŒã€ã‚¹ãƒãƒ›ã§ã®ãƒ–ãƒ©ã‚¦ã‚¸ãƒ³ã‚°(ç‰¹ã«ã‚¹ãƒ¯ã‚¤ãƒ—)ã¨ã®ç›¸æ€§ã‚’è€ƒãˆã‚‹ã¨è‡ªç„¶ãªæŒ™å‹•ã«æ€ãˆã¾ã™ã€‚ã“ã®è¾ºã‚Šã®ä½¿ç”¨ã«ã¤ã„ã¦ã¯whatwgã§ã‚‚æ˜è¨˜ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://html.spec.whatwg.org/multipage/browsing-the-web.html#persisted-user-state-restoration

> If entry's scroll restoration mode is "auto", then the user agent may use entry's scroll position data to restore the scroll positions of entry's document's restorable scrollable regions.

ãƒ–ãƒ©ã‚¦ã‚¶ã®history entryã«æ ¼ç´ã•ã‚Œã‚‹stateã«ã¯scroll position dataã¨ã„ã†ã‚‚ã®ãŒã‚ã‚Šã€ã€Œscroll restoration modeãŒ`auto`ãªã‚‰scroll position dataã‚’ã‚‚ã¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚scroll restoration modeã¯[history.scrollRestoration](https://developer.mozilla.org/ja/docs/Web/API/History/scrollRestoration) ã«`auto`(åˆæœŸå€¤)ã‹`manual`ã‚’ä»£å…¥ã™ã‚‹ã“ã¨ã§è¨­å®šã§ãã¾ã™ã€‚

Next.jsã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯`experimental.scrollRestoration = false`ã¨ãªã£ã¦ãŠã‚Šã€ã“ã®å ´åˆã®`history.scrollRestoration`ã®å€¤ã¯`auto`ã§ã™ã€‚Next.jså§‹ã‚SPAã§ã¯ã€`history.scrollRestoration = 'auto'`ã«ã‚ˆã‚‹ãƒ–ãƒ©ã‚¦ã‚¶å´ã®å¾©å…ƒå‡¦ç†ãŒã†ã¾ãå‹•ä½œã—ãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

### getServerSideProps

`getServerSideProps`ã‚’å«ã‚€ãƒšãƒ¼ã‚¸ã®å ´åˆã€é·ç§»æ™‚ã‚„ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯æ™‚ã«Next.jsã¯`getServerSideProps`ã‚’ã‚µãƒ¼ãƒãƒ¼å´ã§å®Ÿè¡Œã—propsã‚’å–å¾—ã™ã‚‹ã‚ˆã†ãªfetchã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ãã®ãŸã‚ã€ã“ã‚Œã‚‰ã‚’å«ã‚€å ´åˆãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯æ™‚ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¯éåŒæœŸçš„ã«ãªã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã¯Chromeã§æŒ™å‹•ã‚’ç¢ºèªã—ãŸéš›ã®gifã§ã™ã€‚

:::details chrome demo
![](/images/next-js-scroll-restore/default_gssp.gif)
:::

ã“ã®ãƒ‡ãƒ¢ã§ã¯ã€`getServerSideProps`ã«ä»¥ä¸‹ã®ã‚ˆã†ã«sleepå‡¦ç†ã‚’å…¥ã‚Œã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```ts
export const getServerSideProps = async () => {
  await sleep(1000)
  return {
    props: {
      text: 'hello, world',
    },
  }
}
```

another pageã‹ã‚‰ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯ã™ã‚‹éš›ã«å…ˆã«URLãŒå¤‰æ›´ã•ã‚Œã€å°‘ã—æ™‚é–“ã‚’ç½®ã„ã¦ç”»é¢ãŒæç”»ã•ã‚Œã¦ã„ã‚‹æ§˜å­ãŒä¼ºãˆã¾ã™ã€‚ã“ã®ã‚ˆã†ã«ã€`getServerSideProps`ã‚’å«ã‚€ãƒšãƒ¼ã‚¸ã§ã¯**ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ãŒãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚ˆã£ã¦å¾©å…ƒã•ã‚Œã¾ã›ã‚“**ã€‚

### getStaticProps

`getStaticProps`ã‚’å«ã‚€å ´åˆã®ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯ã§ã‚‚ã€`getServerSideProps`åŒæ§˜ã«Next.jsã®å†…éƒ¨å‡¦ç†ã«ã‚ˆã£ã¦`getStaticProps`ã®æˆ»ã‚Šå€¤ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ãªfetchãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã“ã®éš›ã®å¤§ããªé•ã„ã¯fetchã«ã‚ˆã£ã¦å–å¾—ã•ã‚Œã‚‹ã®ãŒé™çš„ãªjsonã§ã‚ã‚‹ã¨ã„ã†ç‚¹ã¨ã€å¤šãã®å ´åˆfetchå…ˆã‹ã‚‰ã¯304 Not ModifiedãŒãƒ¬ã‚¹ãƒãƒ³ã‚¹ã•ã‚Œã‚‹ç‚¹ã§ã™(CDNã‚„Next.jsãŒå‹•ãã‚µãƒ¼ãƒãƒ¼ã‚’æƒ³å®š)ã€‚

ãŸã ã—ã€`getStaticProps`ã¯`getServerSideProps`åŒæ§˜ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã«ã¯éåŒæœŸå‡¦ç†ã‚’ä¼´ã„ã¾ã™ãŒã€ç­†è€…ã®ç’°å¢ƒã§ã¯**Chromeã§ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ãŒå¾©å…ƒã•ã‚Œã€Safariã§ã¯å¾©å…ƒã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ**ã€‚

:::details chrome demo
![](/images/next-js-scroll-restore/default_gsp.gif)
:::

å®Ÿè£…ã‚’ç¢ºèªã—ãŸé™ã‚Šã€Next.jsã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒã—ãªã„ã“ã¨ã€ãã—ã¦Safariã§ã¯å¾©å…ƒã•ã‚Œãªã„(=ãƒ–ãƒ©ã‚¦ã‚¶å·®ç•°ãŒã‚ã‚‹)ã“ã¨ã‹ã‚‰ã‚‚Chromeã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã®å¾©å…ƒã¯Chromeã®å®Ÿè£…ã«ã‚ˆã‚‹ã‚‚ã®ã ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚å„ãƒ–ãƒ©ã‚¦ã‚¶ãŒã©ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å¾©å…ƒå‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã‹ã€ãã‚‚ãã‚‚ã©ã†è¨€ã£ãŸæ¡ä»¶ã§å®Ÿè¡Œã™ã‚‹ã®ã‹ã©ã†ã‹ã«ã¤ã„ã¦ã¯whatwgã®ä»•æ§˜çš„ã«ã¯ãƒ–ãƒ©ã‚¦ã‚¶å´ã§è‡ªç”±ã«å®Ÿè£…ã§ããã†ãªã®ã§ã€Chromeã§ã¯ã‹ãªã‚Šè¤‡é›‘ãªæ¡ä»¶ã‚’ã‚‚ã¨ã«åˆ¤å®šã—ã¦ã„ã‚‹ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

### Data fetchingã‚’å«ã¾ãªã„å ´åˆ

`getServerSideProps`ã‚„`getStaticProps`ã¨ã„ã£ãŸData fetchingæ©Ÿèƒ½ã‚’å«ã¾ãªã„ãƒšãƒ¼ã‚¸ã®å ´åˆã€å‹•çš„ãªpropså–å¾—ãŒãªã„ãŸã‚ã«ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯æ™‚ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã«ã¯fetchã¯å«ã¾ã‚Œãšã€ç›´ã¡ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ãŸã ã—ã“ã®éš›ã«ã‚‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®å¾©å…ƒã•ã‚Œã‚‹ã‹ã©ã†ã‹ã«ã¤ã„ã¦ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚ˆã£ã¦å·®ç•°ãŒã‚ã‚Šã€Chromeã§ã¯å¾©å…ƒã•ã‚Œã¾ã™ãŒSafariã§ã¯å¾©å…ƒã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚

:::details chrome demo
![](/images/next-js-scroll-restore/default_static.gif)
:::

## Scroll amnesia

ã“ã†ã„ã£ãŸã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã®å–ªå¤±ã¯**Scroll amnesia**ã¨å‘¼ã°ã‚Œã¾ã™ã€‚SPAã§ã¯Scroll amnesiaã§ã‚ã£ãŸã‚Šã€çŠ¶æ…‹ã®å¾©å…ƒã¨ã„ã†ã®ãŒè»½è¦–ã•ã‚ŒãŒã¡ãªçŠ¶æ³ã«ã‚ã‚Šã¾ã™ã€‚SPAã®æ“¬ä¼¼é·ç§»ã¯ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ãªé·ç§»ã‚„å¿…è¦æœ€ä½é™ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ãƒ©ã‚¦ãƒ³ãƒ‰ãƒˆãƒªãƒƒãƒ—ã«ã‚ˆã‚‹é«˜é€ŸåŒ–ãŒè¦‹è¾¼ã‚ã‚‹ä¸€æ–¹ã§ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚„çŠ¶æ…‹ã®å¾©å…ƒã®ä½“é¨“ãŒMPAã¨ç•°ãªã‚‹ã“ã¨ã§UXçš„ã«ã¯ä¸€é•·ä¸€çŸ­ã¨ã„ã†çŠ¶æ…‹ã«ãªã£ã¦ã—ã¾ã£ã¦ã„ã‚‹ã‚ˆã†ã«ã‚‚æ„Ÿã˜ã¾ã™ã€‚

ã“ã†ã„ã£ãŸçŠ¶æ³ã‚’æ”¹å–„ã™ã‚‹ãŸã‚ã«ã‚‚ã€whatwgã§ã¯[Navigation API](https://github.com/WICG/navigation-api/blob/main/README.md)ã¨ã„ã†æ–°ãŸãªãƒ–ãƒ©ã‚¦ã‚¶APIã«ã‚ˆã£ã¦SPAã®æ“¬ä¼¼é·ç§»ã®ä½“é¨“æ”¹å–„ãŒæ¤œè¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://blog.jxck.io/entries/2022-04-22/navigation-api.html#%E3%83%95%E3%82%A9%E3%83%BC%E3%82%AB%E3%82%B9%E3%81%AE%E7%AE%A1%E7%90%86

## experimental.scrollRestorationã®å®Ÿè£…

Navigation APIã¯ã¾ã Chromeã§ã—ã‹å®Ÿè£…ã•ã‚Œã¦ãŠã‚‰ãšã€å®Ÿç”¨ã®æ®µéšã«ã¯ãªã„ãŸSPAã§Scroll amnesiaã«å¯¾å¿œã™ã‚‹ã«ã¯åˆ¥é€”å®Ÿè£…ãŒå¿…è¦ã§ã™ã€‚ã“ã‚Œã‚’æœ‰åŠ¹ã«ã™ã‚‹ã®ãŒå†’é ­ã§è¿°ã¹ãŸ`experimental.scrollRestoration`ãƒ•ãƒ©ã‚°ã§ã™ã€‚ã“ã®ãƒ•ãƒ©ã‚°ã‚’æœ‰åŠ¹ã«ã—ãŸéš›ã«Next.jsãŒã©ã†ã‚„ã£ã¦ä½ç½®ã‚’å¾©å…ƒã—ã¦ã„ã‚‹ã‹è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

### å‡¦ç†ã®æ¦‚è¦

å¤§ã¾ã‹ãªå‡¦ç†ã®æ¦‚è¦ã¯ä»¥ä¸‹ã§ã™ã€‚

1. å±¥æ­´ã«å¯¾ã—ã¦keyã‚’ä½œæˆ
2. `next/link`ã§é·ç§»æ™‚(`pushState`)æ™‚ã«keyã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’Session Storageã«ä¿å­˜
3. ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯/ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰æ™‚ã«keyã‚’ã‚‚ã¨ã«Session Storageã‹ã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å–å¾—
4. Next.jsã®renderé–¢æ•°å†…ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ

ã“ã‚Œã‚‰ã®å‡¦ç†ã«ã¤ã„ã¦ã€è©³ç´°ã«ã¿ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

#### 1. å±¥æ­´ã«å¯¾ã—ã¦keyã‚’ä½œæˆ

Next.jsã«ã¯`next/link`ã‚„`useRouter`ãªã©ã§åˆ©ç”¨ã•ã‚Œã‚‹`Router` classãŒå­˜åœ¨ã—ã¾ã™ã€‚ä¸»ã«ã“ã®classã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§åˆ©ç”¨ã•ã‚Œã€ã‚µãƒ¼ãƒãƒ¼å´ã§ã¯å…±é€šã®interfaceã‚’ã‚‚ã£ãŸ`ServerRouter`classãŒåˆ©ç”¨ã•ã‚Œã¾ã™ã€‚

https://github.com/vercel/next.js/blob/v12.2.0/packages/next/shared/lib/router/router.ts#L620

`Router`ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚„[pushState](https://developer.mozilla.org/ja/docs/Web/API/History/pushState)ã«ã‚ˆã‚‹URLæ›´æ–°ã€`getServerSideProps`ã‚’å®Ÿè¡Œã™ã‚‹fetchã®ç™ºè¡Œãªã©ã€Next.jsã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã«å¯¾ã™ã‚‹è²¬å‹™ã‚’è² ã£ã¦ã„ã¾ã™ã€‚ã“ã®`Router`ã§ã€æ–°è¦ã®å±¥æ­´ã«å¯¾ã—ã¦ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªkeyãŒä½œæˆã•ã‚Œã¾ã™ã€‚

å®Ÿã¯12.2.0ã¾ã§ã¯keyã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªæ–‡å­—åˆ—ã§ã¯ãªãå˜ç´”ãªindexã§ã—ãŸãŒã€indexã ã¨å®¹æ˜“ã«å±¥æ­´ãŒç ´ç¶»ã™ã‚‹ãŸã‚ãƒªãƒ­ãƒ¼ãƒ‰ã‚’æŒŸã‚€ã¨å¾©å…ƒã§ããªããªã£ã¦ã„ã¾ã—ãŸã€‚ã“ã‚Œã‚’ä¿®æ­£ã™ã‚‹ãŸã‚ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªkeyã§ç®¡ç†ã™ã‚‹ã‚ˆã†ä¿®æ­£ã—ãŸãƒ—ãƒ«ãƒªã‚¯ã‚’Next.jsã«æŠ•ã’ã¦ã€ç„¡äº‹ãƒãƒ¼ã‚¸ãƒ»ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸã®ã§ç¾åœ¨ã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªæ–‡å­—åˆ—ãŒkeyã¨ãªã£ã¦ã„ã¾ã™(è­˜è€…ã®æ–¹ã«ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¦ã‚‚ã‚‰ã„ãªãŒã‚‰Next.jsã¸åˆPR&ãƒãƒ¼ã‚¸ã§ã—ãŸã€å¬‰ã—ã„)ã€‚

https://github.com/vercel/next.js/pull/36861

#### 2. keyã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’Session Storageã«ä¿å­˜

`next/link`ã§ã®é·ç§»æ™‚ã‚„ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯/ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰æ™‚ã«ã¯ã€**é·ç§»å‰**ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’Session Storageã«`__next_scroll_${key}`ã¨ã„ã‚­ãƒ¼åç§°ã§ä¿å­˜ã—ã¾ã™ã€‚

_popstateæ™‚_
https://github.com/vercel/next.js/blob/v12.2.0/packages/next/shared/lib/router/router.ts#L863-L866

_é·ç§»æ™‚_
https://github.com/vercel/next.js/blob/v12.2.0/packages/next/shared/lib/router/router.ts#L937-L940

#### 3. ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯/ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰æ™‚ã«keyã‚’ã‚‚ã¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å–å¾—

ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯/ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã§**é·ç§»å¾Œ**ã®keyã‚’ã‚‚ã¨ã«ã€Session Storageã‹ã‚‰`__next_scroll_${key}`ã¨ã„ã‚­ãƒ¼åç§°ã§`getItem`ã—ã¦ã€ã‚ã‚Œã°ãã®å€¤ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®æƒ…å ±ã¨ã—ã¦å–å¾—ã—ã¾ã™ã€‚

https://github.com/vercel/next.js/blob/v12.2.0/packages/next/shared/lib/router/router.ts#L870-L875

#### 4. Next.jsã®renderé–¢æ•°å†…ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ

å–å¾—ã—ãŸã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã®å¾©å…ƒæƒ…å ±ã‚’ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®renderå‡¦ç†ã®æœ€å¾Œã§`window.scrollTo`ã«æ¸¡ã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒã—ã¾ã™ã€‚

https://github.com/vercel/next.js/blob/v12.2.0/packages/next/client/index.tsx#L980-L982

### æ®‹ã£ã¦ã‚‹å•é¡Œç‚¹

ä»¥ä¸ŠãŒ`experimental.scrollRestoration`æœ‰åŠ¹æ™‚ã®å¾©å…ƒå‡¦ç†ã«ãªã‚Šã¾ã™ã€‚ãŸã ã—ã€ã“ã®å¾©å…ƒå‡¦ç†ã«ã¯ã¾ã èª²é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã«`Router`ã®`key`ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¦ã—ã¾ã†ãŸã‚ã€ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã®ã¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ãŒå¾©å…ƒã§ããªã„ã®ã§ã™ã€‚

ã“ã‚Œã«ã¤ã„ã¦ã‚‚ä¿®æ­£ãƒ—ãƒ«ãƒªã‚¯ã‚’ä½œæˆã—ã¦ã„ã¾ã™ãŒã€ãªã‹ãªã‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã•ã‚Œãšã€‚ã€‚ã€‚

https://github.com/vercel/next.js/pull/37127

ç¾åœ¨Vercelå†…ã§å®Ÿè£…ãŒé€²ã‚“ã§ã‚‹ã¨æ€ã‚ã‚Œã‚‹[Nested Layout](https://nextjs.org/blog/layouts-rfc)ã«ã‚ˆã£ã¦ãŠãã‚‰ã`Router`ã‚‚å¤§ããå¤‰æ›´ã•ã‚Œã‚‹ã§ã—ã‚‡ã†ã‹ã‚‰ã€ãã®å‰ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ã‚‚ã‚‰ã„ãŸã„ã¨ã“ã‚ã§ã™ã€‚

## (äºˆæƒ³)Navigation APIã‚’åˆ©ç”¨ã—ãŸå®Ÿè£…

å°†æ¥çš„ã«Navigation APIãŒåºƒãã‚µãƒãƒ¼ãƒˆã•ã‚ŒNext.jsã§ã‚‚åˆ©ç”¨ã•ã‚Œã‚‹ã“ã¨ã«ãªã£ãŸå ´åˆã«ã¯ã€å±¥æ­´ã®ç®¡ç†ã‚„Session Storageã®æ“ä½œã¯ä¸è¦ã«ãªã‚Šã¾ã™ã€‚Navigation APIã§ã¯`navigate`ã‚¤ãƒ™ãƒ³ãƒˆæ™‚ã«**é·ç§»ã‚’å®šç¾©ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™**ã€‚

```js
navigation.addEventListener("navigate", e => {
  e.transitionWhile((async () => {
    const data = await fetchData()
    await render(data)
  })())
})
```

Javascriptã‹ã‚‰é·ç§»ã‚’Promiseã§å®šç¾©ã§ãã‚‹ã¨ã„ã†ã“ã¨ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶å´ã§SPAã®é·ç§»ãŒã„ã¤çµ‚ã‚ã£ãŸã‹èªè­˜ã§ãã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶å´ã§ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒ`e.transitionWhile`ã«æ¸¡ã—ãŸPromiseãŒè§£æ±ºã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ãªã‚‹ã®ã§ã€æœ¬ç¨¿ã§è§£èª¬ã—ãŸã‚ˆã†ãªå®Ÿè£…ã¯ä¸€åˆ‡ä¸è¦ã«ãªã‚‹ã¯ãšã§ã™ã€‚

å¿…è¦ã§ã‚ã‚Œã°ã€`e.restoreScroll()`ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã›ã°`transitionWhile`ã«æ¸¡ã™Promiseã®ä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒã§ãã‚‹ã®ã§ã€å°‘ãªãã¨ã‚‚Session Storageã¸ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®æƒ…å ±ã®æ ¼ç´ã¯ä¸è¦ã«ãªã‚Šã¾ã™ã€‚

```js
navigation.addEventListener("navigate", e => {
  e.transitionWhile((async () => {
    const data = await fetchData()
    await render(data)
    e.restoreScroll() // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ
    // renderã«é–¢ä¿‚ãªã„å‡¦ç†
    await sendMeasurement()
    await sendReporting()
  })())
})
```

## ä½™è«‡:Next.jsã§çŠ¶æ…‹ã‚’å¾©å…ƒã™ã‚‹

- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã ã‘ã§ãªãã€çŠ¶æ…‹ã‚‚ã‚ˆãå¤±ã‚ã‚Œã‚Œã‚‹
- Vercelã®ç¤¾é•·ã‚‚å¤§äº‹ãªåŸå‰‡ã¨ã—ã¦ä¸Šã’ã¦ã‚‹
  - https://yosuke-furukawa.hatenablog.com/entry/2014/11/14/141415#5
- recoil + recoil-sync + koichikã•ã‚“ãŒä½œã£ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ãã‚ŒãŒè£œå®Œã§ãã‚‹
- recoil-sync-next
- è¿‘ã€…ã“ã£ã¡ã‚‚è§£èª¬è©³ç´°ã«æ›¸ã“ã†ã¨æ€ã†_
