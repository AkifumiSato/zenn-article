---
title: "Next.js Cacheå›æƒ³"
emoji: "ğŸ‘¨â€ğŸ’»"
type: "idea" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextjs"]
published: true
---

:::message

- ã“ã®è¨˜äº‹ã¯[JSConf JP 2025ã§ç™ºè¡¨ã—ãŸå†…å®¹](https://jsconf.jp/2025/en/talks/nextjs-caching-re-architecture)ã‚’ã€è¨˜äº‹ã¨ã—ã¦åŸ·ç­†ã—ãªãŠã—ãŸã‚‚ã®ã§ã™ã€‚
- ã“ã®è¨˜äº‹ã¯2å¹´å‰ã®[JSConf JPã§ç­†è€…ãŒç™ºè¡¨ã—ãŸå†…å®¹](https://jsconf.jp/2023/talk/akfm-sato-1/)ã«å¯¾ã™ã‚‹ã‚¢ãƒ³ã‚µãƒ¼ã‚½ãƒ³ã‚°ã‚’å«ã¿ã¾ã™ã€‚
  :::

Next.jsã¯å¾“æ¥ã‚ˆã‚Šã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é«˜ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å®Ÿç¾ã™ã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚ã‚‹ã“ã¨ã‚’é‡è¦–ã—ã¦ãã¾ã—ãŸã€‚App Routerã«ãŠã„ã¦ã‚‚ã€ç©æ¥µçš„ãªCacheæ´»ç”¨ã‚’ã¯ã˜ã‚ã•ã¾ã–ã¾ãªãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã«ã‚ˆã‚Šã€é«˜ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å®Ÿç¾ã‚’ç›®æŒ‡ã—ã¦ãã¾ã—ãŸã€‚ä¸€æ–¹ã§ã€ç©æ¥µçš„ãªCacheæ´»ç”¨ã‚„è¤‡é›‘ã™ãã‚‹Cacheã®å½±éŸ¿ç¯„å›²ã¯ã€é–‹ç™ºè€…ã«å¤šãã®æ··ä¹±ã‚’ã‚‚ãŸã‚‰ã—ã¾ã—ãŸã€‚

v16ã§å°å…¥ã•ã‚ŒãŸ[Cache Components](https://nextjs.org/docs/app/getting-started/cache-components)ã¯ã€Next.jsã®Cacheã®ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ¢ãƒ‡ãƒ«ã‚’å¤§ããå¤‰æ›´ã™ã‚‹ã‚‚ã®ã§ã‚ã‚Šã€ã“ã‚Œã¾ã§ã®å¤šãã®èª²é¡Œã‚’è§£æ±ºã—ã†ã‚‹æ ¹æœ¬çš„ãª**ãƒªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**ã§ã™ã€‚ã“ã®è¨˜äº‹ã§ã¯ã€Cache ComponentsãŒä½•ã‚’è§£æ±ºã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã®ã‹ã€ãªãœãƒªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«è‡³ã£ãŸã®ã‹ãªã©ã®æ­´å²çš„çµŒç·¯ã‚’è§£èª¬ã—ã¾ã™ã€‚

## Next.jsã®æ­´å²

Next.jsã«ã¯ç¾åœ¨ã€Pages Routerã¨App Router2ã¤ã®RouterãŒåŒæ¢±ã•ã‚Œã¦ã„ã¾ã™^[å‚è€ƒ: [App Router and Pages Router](https://nextjs.org/docs#app-router-and-pages-router)]ã€‚2016å¹´ã«ç™ºè¡¨ã•ã‚ŒãŸåˆæœŸã®Next.jsã¯ç¾åœ¨Pages Routerã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ã§ã‚ã‚Šã€SSGã‚µãƒãƒ¼ãƒˆã‚„ISRã®ç™ºæ˜ãªã©ã€é™çš„åŒ–ã«ã‚ˆã‚‹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã‚’ç©æ¥µçš„ã«è¡Œã£ã¦ãã¾ã—ãŸã€‚ãã®å¾Œ[React Server Components](https://github.com/reactjs/rfcs/blob/main/text/0188-server-components.md)ã‚’ã‚µãƒãƒ¼ãƒˆã—ãŸæ–°ãŸãªRouterã¨ã—ã¦ã€App RouterãŒé–‹ç™ºã•ã‚Œã¾ã—ãŸã€‚

| å¹´      | æ¦‚è¦            | è©³ç´°                                |
| ------- | --------------- | ----------------------------------- |
| 2013/05 | ReactãŒå…¬é–‹     |                                     |
| 2016/10 | Next.jsãŒå…¬é–‹   |                                     |
| 2018~   | Gatsby.jsã®å°é ­ | SSGãŒæ³¨ç›®ã•ã‚Œã‚‹                     |
| 2019/07 | Next.js@v9.0    | dynamicãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ»Typescriptå¯¾å¿œ |
| 2020/03 | Next.js@v9.3    | SSGå¯¾å¿œ                             |
| 2020/07 | Next.js@v9.5    | ISRå¯¾å¿œ                             |
| 2022/05 | Layout RFCç™ºè¡¨  | å¾Œã®App Router                      |
| 2022/10 | Next.js@v13.0   | App Router(Beta)                    |
| 2023/05 | Next.js@v13.4   | App Router(Stable)                  |

## Legacy Cache: App RouteråˆæœŸã®Cacheï¼ˆv13~v14ï¼‰

App Routerã«ãŠã„ã¦ã‚‚ã€Pages Routerã§åŸ¹ã‚ã‚ŒãŸé™çš„åŒ–ã«ã‚ˆã‚‹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–æ€æƒ³ã¯å¼•ãç¶™ãŒã‚Œã¦ã„ã¾ã™ã€‚å¾“æ¥SSGã‚„ISRã¨å‘¼ã°ã‚ŒãŸãƒšãƒ¼ã‚¸ã®é™çš„åŒ–ã¯Cacheã®1ç¨®ã¨ã—ã¦ä½ç½®ä»˜ã‘ã‚‰ã‚Œã€ã‚ˆã‚Šé«˜åº¦ãªæœ€é©åŒ–ã®ãŸã‚ã«4å±¤ã®CacheãŒå°å…¥ã•ã‚Œã¾ã—ãŸã€‚

![Next.jsã®Cacheã®å¤šå±¤åŒ–](/images/nextjs-caching-history/cache-layer.png)

ä»¥ä¸‹ã¯[å…¬å¼ã®è¡¨](https://nextjs.org/docs/app/guides/caching#overview)ã‚’ç¿»è¨³ã—ãŸã‚‚ã®ã§ã™ã€‚

| Mechanism               | What              | Where  | Purpose                                    | Duration                                |
| ----------------------- | ----------------- | ------ | ------------------------------------------ | --------------------------------------- |
| **Request Memoization** | APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ãªã© | Server | React Component treeã«ãŠã‘ã‚‹ãƒ‡ãƒ¼ã‚¿ã®å†åˆ©ç”¨ | ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨                          |
| **Data Cache**          | APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ãªã© | Server | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã¾ãŸããƒ‡ãƒ¼ã‚¿ã®å†åˆ©ç”¨   | æ°¸ç¶šçš„ (revalidateå¯)                   |
| **Full Route Cache**    | HTMLã‚„RSC payload | Server | ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚³ã‚¹ãƒˆã®æœ€é©åŒ–                 | æ°¸ç¶šçš„ (revalidateå¯)                   |
| **Router Cache**        | RSC Payload       | Client | ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã”ã¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‰Šæ¸›         | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ»æ™‚é–“ (revalidateå¯) |

ã“ã‚Œã‚‰ã¯ãã‚Œãã‚Œæœ€é©åŒ–ã®è¦³ç‚¹ãŒç•°ãªã‚‹ãŸã‚ã€ç†è§£ã™ã‚Œã°é«˜åº¦ãªãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚„è¨­è¨ˆãŒå¯èƒ½ã§ã™ã€‚ä¸€æ–¹ã§å¤šå±¤ã®Cacheã¯ãã‚Œè‡ªä½“ãŒè¤‡é›‘ãªãŸã‚ã€ãƒã‚°ã‚„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸è¶³ã€é«˜ã„è¨­è¨ˆé›£æ˜“åº¦ãªã©é–‹ç™ºè€…ã«å¤šãã®è² æ‹…ã‚’å¼·ã„ã‚‹ã“ã¨ã¨ãªã‚Šã¾ã—ãŸã€‚

### èª²é¡Œ1: äºˆæƒ³å›°é›£ãªãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒ

å½“æ™‚ç­†è€…ãŒCacheå‘¨ã‚Šã§èª²é¡Œã«æ„Ÿã˜ã¦ã„ãŸç‚¹ã‚’ã€ã„ãã¤ã‹ä¾‹ç¤ºã—ã¾ã™ã€‚

Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã«ãŠã„ã¦ã€Cacheã§ããªã„ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã¯éå¸¸ã«ä¸€èˆ¬çš„ã§ã™ã€‚App RouteråˆæœŸã«ãŠã„ã¦ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç©æ¥µçš„ãªCacheæ´»ç”¨æˆ¦ç•¥ãŒæ¡ç”¨ã•ã‚Œã¦ã„ãŸãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒãŒCacheã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ã«ã¯Opt-outãŒå¿…è¦ã§ã—ãŸã€‚ã—ã‹ã—ã€Opt-outã®æ‰‹æ®µã‚‚è¤‡æ•°ã‚ã‚Šã€å½±éŸ¿ç¯„å›²ãŒåºƒç¯„ã«åŠã‚“ã ãŸã‚ã€é–‹ç™ºè€…ã¯å¤šå±¤ã®Cacheã¨è¤‡æ•°ã®Opt-outæ‰‹æ®µã‚’è€ƒæ…®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

ä»¥ä¸‹ã®å®Ÿè£…ä¾‹ã§è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚ä¸‹è¨˜å®Ÿè£…ä¾‹ã§ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«ãƒ©ãƒ³ãƒ€ãƒ ãªTodoã‚’å–å¾—ã™ã‚‹ã“ã¨ã‚’æœŸå¾…ã—ã¦`await getRandomTodo()`ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

```tsx
export default async function Page() {
  const { todo } = await getRandomTodo();
  // ...
}
```

ã—ã‹ã—ã€ã“ã®ã‚³ãƒ¼ãƒ‰ã®èª­ã¿æ‰‹ãŒ`await getRandomTodo()`ã®CacheæŒ™å‹•ã«ã¤ã„ã¦æ­£ã—ãç†è§£ã™ã‚‹ã«ã¯ã€å¤šå²ã«ã‚ãŸã‚‹ã‚³ãƒ¼ãƒ‰ã‚„è¨­å®šã‚’å‚ç…§ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

- Pageå†…ã§`cookies()`ã‚„`headers()`ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹
- `getRandomTodo()`å†…ã§å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã§ã‚ã‚ã†`fetch()`ã§ã€`cache: "no-store"`ã‚„`next: { revalidate: 0 }`ãŒã‚ªãƒ—ã‚·ãƒ§ãƒ³æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹
- Pageã‚„Layoutã§CacheæŒ™å‹•ã«é–¢ã™ã‚‹[Route Segment Config](https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config)ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹

ã“ã®ã‚ˆã†ã«ã€ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«å‹•çš„ã«å®Ÿè¡Œã™ã‚‹ã«ã¯åºƒç¯„ãªã‚³ãƒ¼ãƒ‰ç†è§£ã¨ä»•æ§˜ç†è§£ã‚’å¿…è¦ã¨ã—ãŸãŸã‚ã€é–‹ç™ºè€…ã«å¤§ããªè² æ‹…ã‚’å¼·ã„ã¾ã—ãŸã€‚

### èª²é¡Œ2: è¤‡é›‘ãªCacheè¨­å®š

å‰è¿°ã®é€šã‚Šã€CacheæŒ™å‹•ã¯Route Segment Configã§åˆ¶å¾¡ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã—ãŸãŒã€ã“ã‚Œã‚‰ã®è¨­å®šã¯é«˜åº¦ãªç†è§£ã¨åºƒç¯„ãªå½±éŸ¿ç¯„å›²ã‚’ä¼´ã†ãŸã‚ã€é–‹ç™ºè€…ã«å¤§ããªè² æ‹…ã‚’å¼·ã„ã¾ã—ãŸã€‚

ä»¥ä¸‹ã¯ã€Cacheã«é–¢ä¿‚ã™ã‚‹Route Segment Configã§ã™ã€‚

```ts
export const dynamic = "auto";
// 'auto' | 'force-dynamic' | 'error' | 'force-static'
export const fetchCache = "auto";
// 'auto' | 'default-cache' | 'only-cache'
// 'force-cache' | 'force-no-store' | 'default-no-store' | 'only-no-store'
export const revalidate = false;
// false | 0 | number
// ...
```

ã“ã‚Œã‚‰ãŒLayoutã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã¨ã€ä¸‹å±¤ã®Routeå…¨ã¦ã«å½±éŸ¿ã™ã‚‹ãŸã‚ã€é–‹ç™ºè€…ã¯å½±éŸ¿ç¯„å›²ã‚’æ…é‡ã«è¨­è¨ˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

å®Ÿéš›ã«ã¯ã€ã“ã‚Œã‚‰ã®è¨­å®šã‚’æ´»ç”¨ã—ã¦Route Segmentå˜ä½ã§æœ€é©åŒ–ã™ã‚‹ã‚ˆã‚Šã€æœ€ä¸Šä½ã®Layoutã§`export const dynamic = "force-dynamic";`ã‚’è¨­å®šã—ã¦Cacheã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§Opt-outã™ã‚‹æ–¹ãŒã€ä¸€èˆ¬çš„ãªãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¨ãªã£ã¦ã„ãŸã¨æ€ã„ã¾ã™ã€‚

### èª²é¡Œ3: ä¸é€æ˜ã§ä¸å®‰å®šãªRouter Cache

å‰è¿°ã®èª²é¡Œã¯ã‚µãƒ¼ãƒãƒ¼å´ã®Cacheï¼ˆData Cache, Full Route Cacheï¼‰ã«é–¢ã™ã‚‹ã‚‚ã®ã§ã—ãŸãŒã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®Cacheã§ã‚ã‚‹Router Cacheã«ã¤ã„ã¦ã‚‚æ§˜ã€…ãªèª²é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚

- StaticãªRouteã¯ 5m Cacheã•ã‚Œã‚‹
- DynamicãªRouteã¯ 30s Cacheã•ã‚Œã‚‹
- ä¸Šè¨˜ä»•æ§˜ã‚„ã€Router CacheãŒç ´æ£„ã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ã¤ã„ã¦è¨˜è¼‰ãŒãªã‹ã£ãŸ

ã“ã®ã“ã¨ã¯2å¹´å‰ã®JSConf JPã§ç­†è€…ãŒç™ºè¡¨ã—ãŸå†…å®¹ã§ã‚‚è§¦ã‚Œã¦ã„ã¾ã™ã€‚

https://jsconf.jp/2023/talk/akfm-sato-1/

ã¾ãŸã€Router Cacheã®ãƒã‚°ã‚‚ç›¸ã¾ã£ã¦ã€ãƒã‚°ãªã®ã‹ä»•æ§˜ãªã®ã‹ã‚ã‹ã‚‰ãªã„æŒ™å‹•ã¯é–‹ç™ºè€…ã«å¤šãã®æ··ä¹±ã¨ä¸å®‰ã‚’ã‚‚ãŸã‚‰ã—ã¾ã—ãŸã€‚

## Cache Improvement: è­°è«–ã¨æ”¹å–„ï¼ˆv14~v15ï¼‰

åˆæœŸã®App Routerã«ãŠã‘ã‚‹Cacheã¯ã€å‹•çš„ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹ç™ºã™ã‚‹é–‹ç™ºè€…ã«ã¨ã£ã¦ã¨ã‚‚ã‹ãæ‚©ã¿ã®ç¨®ã§ã—ãŸã€‚Next.jsé–‹ç™ºãƒãƒ¼ãƒ ã«ã¯ã€SNSã‚„GitHubã®issueã§å¤šæ•°ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒå¯„ã›ã‚‰ã‚Œã¾ã—ãŸãŒã€é–‹ç™ºãƒãƒ¼ãƒ ã®æƒ³å®šã¨ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®éœ€è¦ã«ã¯ä¸€å®šèªè­˜ã®ä¹–é›¢ãŒè¦‹ã‚‰ã‚Œã¾ã—ãŸã€‚

ã“ã®ã‚ˆã†ãªçŠ¶æ³ã‚’è§£æ¶ˆã™ã¹ãã€Next.jsé–‹ç™ºãƒãƒ¼ãƒ ã¯Discussionã‚’ä½œæˆã—ã€ãã“ã§é–‹ç™ºãƒãƒ¼ãƒ ã®æã„ã¦ã‚‹ä¸–ç•Œè¦³ã¨ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®éœ€è¦ã‚’ã™ã‚Šåˆã‚ã›å§‹ã‚ã¾ã—ãŸã€‚

https://github.com/vercel/next.js/discussions/54075

ã€Œã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãŒæ±‚ã‚ã¦ã‚‹ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã¯ä½•ã‹ï¼Ÿã€ã€ã€ŒRouter Cacheã®å¯¿å‘½ã¯è¨­å®šã§ãã‚Œã°è§£æ±ºã™ã‚‹ã®ã‹ï¼Ÿã€ã€Œä»–ã®è§£æ±ºæ–¹æ³•ã¯ãªã„ã®ã‹ï¼Ÿã€ã¨ã„ã£ãŸè­°è«–ãŒé‡ã­ã‚‰ã‚Œã€Next.jsé–‹ç™ºãƒãƒ¼ãƒ ã¯æ”¹å–„æ–¹é‡ã‚’æ…é‡ã«æ¤œè¨ã—ã¾ã—ãŸã€‚

### æ”¹å–„1: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ”¹å–„

App Routerå½“åˆã®Cacheã¯ã¨ã‚‚ã‹ããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ãŸãŸã‚ã€ä»•æ§˜ã‚’ç†è§£ã™ã‚‹ã«ã¯æŒ™å‹•ã®è¦³æ¸¬ã¨ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒå¿…è¦ã§ã—ãŸãŒã€ä¸Šè¨˜Discussionãªã©ã‚’çµŒã¦ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«Cacheæˆ¦ç•¥ã®è©³ç´°ã‚’è§£èª¬ã™ã‚‹ãƒšãƒ¼ã‚¸ã¨ã—ã¦[Caching in Next.js](https://nextjs.org/docs/app/guides/caching)ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Next.jsé–‹ç™ºãƒãƒ¼ãƒ ãŒæã„ã¦ã‚‹Cacheæˆ¦ç•¥ã®è©³ç´°ãŒæ˜ç¤ºã•ã‚Œã€é€æ˜æ€§ãŒå‘ä¸Šã—ã¾ã—ãŸã€‚

- 4å±¤ã®Cacheã®æ˜è¨˜
- å„Cacheã®å½¹å‰²
- Static, Dynamic Renderingã‚„ã“ã‚Œã‚‰ã®æ¡ä»¶ã«ãªã‚‹Dynamic APIsã®å®šç¾©

### æ”¹å–„2: staleTimesã‚ªãƒ—ã‚·ãƒ§ãƒ³

[#èª²é¡Œ3: ä¸é€æ˜ã§ä¸å®‰å®šãªRouter Cache](#èª²é¡Œ3-ä¸é€æ˜ã§ä¸å®‰å®šãªrouter-cache)ã§è§¦ã‚ŒãŸé€šã‚Šã€å½“åˆã®App Routerã§ã¯Router Cacheã®æœ‰åŠ¹æœŸé™ã¯å›ºå®šã•ã‚Œã¦ãŠã‚Šã€è¨­å®šã§ãã¾ã›ã‚“ã§ã—ãŸãŒã€ã“ã‚Œã‚’è¨­å®šå¯èƒ½ã«ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦v14.2ã§`staleTimes`ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚

```ts
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  experimental: {
    staleTimes: {
      dynamic: 30,
      static: 180,
    },
  },
};

export default nextConfig;
```

ã¾ãŸã€DynamicãªRouteãŒ30s Cacheã•ã‚Œã‚‹ã“ã¨ã«ã¤ã„ã¦ã‚‚å¤šãã®æ··ä¹±ã‚’æ‹›ã„ãŸãŸã‚ã€v15ã§`staleTimes.dynamic`ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯30sã‹ã‚‰0sã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚

### æ”¹å–„3: `fetch()`ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆCacheå»ƒæ­¢

`fetch()`ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§Cacheã•ã‚Œã‚‹ã“ã¨ã«ã¤ã„ã¦ã‚‚å¤šãã®æ··ä¹±ã‚’æ‹›ã„ãŸãŸã‚ã€v15ã§`fetch()`ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆCacheãŒå»ƒæ­¢ã•ã‚Œã¾ã—ãŸã€‚

ãŸã ã—ã€v15ä»¥é™ã‚‚`fetch()`ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§**Dynamic Renderingã«ãªã‚‰ãªã„**ã¨è¨€ã†ç‚¹ã¯ã€é–‹ç™ºè€…ã®æ··ä¹±ã‚’è§£æ¶ˆã—ãã‚‰ãªã‹ã£ãŸãŸã‚ã€æ”¹å–„ã¯ã—ãŸãŒè§£æ¶ˆã¯ã—ãªã‹ã£ãŸã¨ç­†è€…ã¯æ„Ÿã˜ã¦ã„ã¾ã™ã€‚

```ts
const res = await fetch(`https://...`, {
  // `undefined`(default): Data Cacheã¯ç„¡åŠ¹ã€ãŸã ã—Dynamic Renderingã«ã¯**ãªã‚‰ãªã„**
  // `"no-store"`: Data Cacheã¯ç„¡åŠ¹ã€Dynamic Renderingã‚’å¼·åˆ¶
  // `"force-cache"`: Data Cacheã¯æœ‰åŠ¹
  cache: "force-cache",
});
```

::::details ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å¤‰æ›´ã«è¸ã¿åˆ‡ã£ãŸèƒŒæ™¯: PPRã®ç™ºè¦‹

å‰è¿°ã®é€šã‚Šã€Next.jsã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é«˜ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å®Ÿç¾ã™ã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚ã‚‹ã“ã¨ã‚’é‡è¦–ã—ã¦ãã¾ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§Cacheæ´»ç”¨ã™ã‚‹æˆ¦ç•¥ã®å¤‰æ›´ã¯ã€ã“ã®ä¾¡å€¤è¦³ã«ç›¸åã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€å½“åˆNext.jsé–‹ç™ºãƒãƒ¼ãƒ ã¯æ…é‡ãªå§¿å‹¢ã§ã—ãŸã€‚ã—ã‹ã—ã€Partial Pre-Renderingï¼ˆPPRï¼‰ã®ç™ºè¦‹ãŒçŠ¶æ³ã‚’å¤§ããå¤‰ãˆã¾ã—ãŸã€‚

PPRã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€ç­†è€…ã®éå»ã®è¨˜äº‹ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

https://zenn.dev/akfm/articles/nextjs-partial-pre-rendering

::::

## Cache Re-Architecture: æ ¹æœ¬çš„ãªæ”¹å–„ï¼ˆv15~v16ï¼‰

v14~v15ã§Next.jsã®Cacheã¯ç€å®Ÿã«æ”¹å–„ã‚’é‡ã­ã¾ã—ãŸã€‚ã—ã‹ã—ã€å¤šå±¤ã®Cacheã‚„äºˆæƒ³å›°é›£ãªå½±éŸ¿ç¯„å›²ãªã©ã€æ ¹æœ¬çš„ãªè¤‡é›‘ã•ã¯è§£æ¶ˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚æ ¹æœ¬çš„ãªè¤‡é›‘æ€§ã®è§£æ¶ˆã«ã¯ã€æ ¹æœ¬çš„ãªãƒªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãŒå¿…è¦ã§ã—ãŸã€‚ãã“ã§æ‰“ã¡å‡ºã•ã‚ŒãŸã®ãŒ`"use cache"`ã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å®£è¨€ã™ã‚‹ä¸–ç•Œè¦³ã§ã™ã€‚

```tsx
// Function Level
export async function getData() {
  "use cache";

  return fetch("...").then((res) => res.json());
}

// Component Level
export default async function Page() {
  "use cache";

  return (
    <>
      <h1>Title</h1>
      <p>...</p>
    </>
  );
}
```

`"use cache"`ã¯2024å¹´ã®Next Confã‚„å…¬å¼ãƒ–ãƒ­ã‚°[Our Journey with Caching](https://nextjs.org/blog/our-journey-with-caching)ã§Dynamic IOã¨ã„ã†ãƒ•ãƒ©ã‚°ã§å®Ÿè£…ä¸­ã§ã‚ã‚‹ã“ã¨ãŒç™ºè¡¨ã•ã‚Œã¾ã—ãŸã€‚ãã®å¾Œã€v16ã§PPRã¨Dynamic IOã‚’çµ±åˆã—ãŸ[Cache Components](https://nextjs.org/docs/app/getting-started/cache-components)ãŒå°å…¥ã•ã‚Œã¾ã—ãŸã€‚

:::message
Cache Componentsã¯ãƒ•ãƒ©ã‚°ã«ã‚ˆã£ã¦æœ‰åŠ¹åŒ–ã§ãã¾ã™ã€‚ãƒ•ãƒ©ã‚°ã‚’æœ‰åŠ¹åŒ–ã—ãªã‘ã‚Œã°å¾“æ¥ã®ä¸–ç•Œè¦³ã‚’ç¶­æŒã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
:::

Cache Componentsã¯`"use cache"`ã‚’å§‹ã‚ã€æ§˜ã€…ãªæŠ€è¡“çš„å¤‰æ›´ã«ã‚ˆã£ã¦æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚

### `"use cache"`

### `<Suspense>`

### PPR

### Segment Cache

## è€ƒå¯Ÿ

## æ„Ÿæƒ³
