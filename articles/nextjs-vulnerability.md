---
title: "Next.jsのSSRF脆弱性"
emoji: "⚠️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["react", "nextjs"]
published: false
---

Next.jsで**SSRF**（=Server Side Request Forgery）の脆弱性が発覚したことが話題になったので、調査した内容をまとめておこうと思います。対象の脆弱性は以下です。

https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-34351

## 脆弱性の概要

SSRF脆弱性は本来到達できないサーバーに対して、公開されてるサーバーを経由してアクセスすることができてしまう脆弱性です。

https://blog.tokumaru.org/2018/12/introduction-to-ssrf-server-side-request-forgery.html

今回のNext.jsの脆弱性は、httpヘッダーの`Host`もしくは`x-forwarded-host`を書き換えることでNext.jsサーバーから見えるサーバーに自由にhttpリクエストを送信できてしまうものです。例えば、外部には公開してない内部APIに対してGETリクエストを送信できる可能性があります。

この脆弱性には以下の条件が伴います。

- Next.jsをself hostingで運用している
- Next.jsアプリケーションがServer Actionsを利用している
- Server Actionが`redirect()`を`/`から始まるパスで呼び出している

これらの条件を満たす時に、SSRF攻撃が成り立つ可能性があります。

### 最新バージョンでの状況

本脆弱性は一応v14.1.1で解消されています。ただし、カスタムサーバー（expressやfastify）を利用している場合、自身で環境変数`__NEXT_PRIVATE_HOST`を設定しないと解消してない可能性があります。

:::message alert
実装を確認した限りカスタムサーバーでは解消してない可能性が高いですが、筆者は未検証で実装を元に述べているので、これらの条件が当てはまる方は自身で脆弱性の有無を検証することをお勧めします。
:::

## 脆弱性の直接的な原因

脆弱性が解消されたとされるのがv14.1.1なので、v14.1.0時点での実装を元に説明します。今回の脆弱性は`redirect()`を呼び出した時の処理に起因しています。

`createRedirectRenderResult`は命名の通り、`redirect()`を呼び出した時に返されるRSC Payloadを生成する関数です。

https://github.com/vercel/next.js/blob/v14.1.0/packages/next/src/server/app-render/action-handler.ts#L147C16-L153

この関数の中でリクエストオブジェクトの`Host`を参照し、`fetchUrl`を生成しています。

https://github.com/vercel/next.js/blob/v14.1.0/packages/next/src/server/app-render/action-handler.ts#L160-L163

そしてそれをそのまま、`fetch`の引数に利用しています。

https://github.com/vercel/next.js/blob/v14.1.0/packages/next/src/server/app-render/action-handler.ts#L195-L202

つまり、`Host`を書き換えればこのフォーマットに沿ったURLを生成することができ、任意のサーバーにリクエストを送信することができてしまうのです。

## 脆弱性の原因となった箇所の周辺実装

TBW

### Server Actions+redirectの挙動
