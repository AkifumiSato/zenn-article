---
title: "Next.jsと認証の基礎"
emoji: "🔐"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["nextjs"]
published: false
---

認証や認可、Next.js で実装する時の構成とかについて時間が経つとすぐ忘れてしまうので、記事で残しておこうかと思います。

## 認証と認可

**認証**と**認可**は別なものです。よく聞く OAuth2.0 は 3rd party 向けの認可の仕組みを定義したものであって、**認証の仕組みではない**のでこの差を理解しないまま流用すると誤った認証や攻撃対象となってしまうリスクを伴います。

:::details 参考記事

- [OAuth 認証とは何か?なぜダメなのか](https://ritou.hatenablog.com/entry/2020/12/01/000000)
- [単なる OAuth 2.0 を認証に使うと、車が通れるほどのどでかいセキュリティー・ホールができる](https://www.sakimura.org/2012/02/1487/)
- [OAuth 2.0 に潜む「5 つの脆弱性」と解決法](https://atmarkit.itmedia.co.jp/ait/articles/1710/24/news011_2.html)
- [【JWT】 入門](https://qiita.com/Naoto9282/items/8427918564400968bd2b)
- [RFC 6749（日本語訳）](https://tex2e.github.io/rfc-translater/html/rfc6749.html)

:::

### 認可とは

認可とは、あるリソースに対してアクセスを許可することです。あるリソースとは例えば Google photo の画像かもしれないし、Github のリポジトリのソースかもしれません。はたまた名前やメールアドレスなどの個人情報を含むものかもしれません。認可はこれらの**リソースに対してリソースオーナーであるユーザーが許可する**ことを指しています。
身近なもので言うと、切符なんかがよく例に出されます。駅に入るには、認可を受けた人（＝切符を持ってる人）だけであってその人の身分の証明であったり、その切符を自分で買ったか人にもらったのかは関係ありません。
もしくは 3rd party のサービスがユーザーの許可を得て、ユーザーの Twitter に代理投稿するのも認可になります。ツイッターに投稿するのは本人もしくは本人の許可を得た 3rd party なサービスであって、必ずしも本人しかリソースにアクセスできるわけではないのです。

### 認証とは

一方で認証とは、通信してる**相手が誰かを確認・証明する**ものです。パスワードや生体情報、SMS による認証など個人を確実に特定するためにいくつかの認証方法が存在します。似たようなフローを経て認可を行うことも多く、認証を持ってリソースへのアクセスを許可してたりするため、認証と認可は混在しがちです。英語表記も認証＝ Authentication）と認可＝ Authorization で似てて略すとどちらも Auth となりそうで日本人にとってはより混乱しやすい原因になってる気がします（少なくとも僕は一般的に Auth と呼んでるのがどっちかわからなくなりました）。

### OAuth2.0

[OAuth2.0](http://openid-foundation-japan.github.io/rfc6749.ja.html)は前述の通り、認可のための仕組みです。時々聞く「OAuth 認証」と言うのは誤りというか、区別せずに認証に OAuth を利用するとセキュリティーホールになってしまうので十分注意しましょう。
OAuth を安易に認証に利用した場合のリスクや攻撃については、多くの記事が存在するのでいくつか参考記事をリンクしておきます。これらの記事はちょっと長かったり難しかったりしますが、そもそも認証周りや攻撃はどう頑張っても難しいところなので何度も読んで理解するよう努めたいところです。

https://ritou.hatenablog.com/entry/2020/12/01/000000
https://atmarkit.itmedia.co.jp/ait/articles/1710/24/news011_2.html

### OAuth 認証の脆弱性

#### CSRF

#### リプレイ攻撃

<!-- 以下前に書いた際の残り
題材的には筆者が以前から趣味で作ってる~~永遠に完成しない~~Web アプリ（Next.js+Nest.js） の構成の話を中心とします。

### 作ってるもの

作ってるものはざっくりこんな感じです。
ドメインとかも取ってあるけど、正直勉強がてら作ってるのでこのまま永遠に完成しないか完全作り直すかもなので詳細は省略。

- Google 認証付き Web アプリケーション
- Vercel+Next と AWS copilot with Fargate+Nest でデプロイしたい

ISR したかったのとデプロイやセキュリティ周りとか考える量も減るので、フロントは Vercel にしました。API は永続化できないことにはしょうがないので AWS copilot を使って Fargate で構成してます。
ということでフロント側は Vercel、バックエンドは AWS Fargate で構築してる API という構成になっています。
 -->

## 構成メモ

- introduction
  - Next と認証のメモだよ
- 認証と認可
  - 認証と認可
  - OAuth2
  - OAuth 認証の脆弱性
    - CSRF
    - リプレイ攻撃
- Open ID Connect
  - Open ID Connect(OIDC) とは
  - ID トークンから取得できるもの
  - nonce の検証
  - cookie に格納する際の設定
    - http only
    - secure
    - same site
- 実際の処理
  - 処理フロー
    - （図）
    - API へアクセス
    - Cookie 付与
    - 次回からログイン情報取れる
  - cookie
    - http only
    - same site
    - secure
