---
title: "Next.jsと認証"
emoji: "🔐"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["nextjs"]
published: false
---

認証や認可、Next.js で実装する時の構成とかについて時間が経つとすぐ忘れてしまうので、備忘録かねて記事で残しておこうかと思います。

## 認証と認可

まず認証周りの整理から。
**認証**と**認可**は別なものです。よく聞く OAuth2.0 は 3rd party 向けの認可の仕組みを定義したものであって、**認証の仕組みではない**のでこの差を理解しないまま流用すると誤った認証や攻撃対象となってしまうリスクを伴います。

:::details 参考記事

- [OAuth 認証とは何か?なぜダメなのか](https://ritou.hatenablog.com/entry/2020/12/01/000000)
- [単なる OAuth 2.0 を認証に使うと、車が通れるほどのどでかいセキュリティー・ホールができる](https://www.sakimura.org/2012/02/1487/)
- [OAuth 2.0 に潜む「5 つの脆弱性」と解決法](https://atmarkit.itmedia.co.jp/ait/articles/1710/24/news011_2.html)
- [【JWT】 入門](https://qiita.com/Naoto9282/items/8427918564400968bd2b)
- [RFC 6749（日本語訳）](https://tex2e.github.io/rfc-translater/html/rfc6749.html)
- [ID トークンの検証](https://qiita.com/KWS_0901/items/c842644b0c65685b2526#4-jwt-%E7%BD%B2%E5%90%8D%E6%A4%9C%E8%A8%BC)

:::

### 認可とは

認可とは、あるリソースに対してアクセスを許可することです。あるリソースとは例えば Google photo の画像かもしれないし、Github のリポジトリのソースかもしれません。はたまた名前やメールアドレスなどの個人情報を含むものかもしれません。認可はこれらの**リソースに対してリソースオーナーであるユーザーが許可する**ことを指しています。
身近なもので言うと、切符なんかがよく例に出されます。駅に入るには、認可を受けた人（＝切符を持ってる人）だけであってその人の身分の証明であったり、その切符を自分で買ったか人にもらったのかは関係ありません。
もしくは 3rd party のサービスがユーザーの許可を得て、ユーザーの Twitter に代理投稿するのも認可になります。ツイッターに投稿するのは本人もしくは本人の許可を得た 3rd party なサービスであって、必ずしも本人しかリソースにアクセスできるわけではないのです。

### 認証とは

一方で認証とは、通信してる**相手が誰かを確認・証明する**ものです。パスワードや生体情報、SMS による認証など個人を確実に特定するためにいくつかの認証方法が存在します。似たようなフローを経て認可を行うことも多く、認証を持ってリソースへのアクセスを許可してたりするため、認証と認可は混在しがちです。英語表記も認証＝ Authentication と認可＝ Authorization で似てて略すとどちらも Auth となりそうで日本人にとってはより混乱しやすい原因になってる気がします（少なくとも僕は一般的に Auth と呼んでるのがどっちかわからなくなりました）。

### 用語説明

| 名称               | 例                              | 説明                                                                                                                                                                                           |
| ------------------ | ------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| リソース           | Google Photo の画像             | 保護されたリソース。                                                                                                                                                                           |
| アクセストークン   | -                               | 保護されたリソースへのアクセスを許可するトークン。リクエストに付与して利用する。検証を挟まず安易に保存するとセキュリティホールになる。秘密鍵を用いて内容が改竄されてないか検証する必要がある。 |
| ID トークン        | -                               | 認証完了時に発行されるトークン。トークンの中身を検証して、成功したら ID とセッションを紐づけて利用したりする。秘密鍵を用いて内容が改竄されてないか検証する必要がある。                         |
| リソースオーナー   | 一般ユーザー                    | リソースの所有者。                                                                                                                                                                             |
| リソースサーバー   | Google Photo                    | 保護されたリソースを保持・管理してるサーバー。アクセストークンなどを持ってアクセスが許可される                                                                                                 |
| クライアント（RP） | 画像加工の Web サービス         | OAuth や Open ID Connect を利用し、サービスを提供する Web アプリケーションなど。Replying Party（RP）と呼ばれることもある。                                                                     |
| idP/認可サーバー   | Google アカウントの認証サービス | OAuth ではアクセストークン、OIDC では ID トークンの発行を担う。                                                                                                                                |

## OAuth2.0 と Open ID Connect

### OAuth2.0

[OAuth2.0](http://openid-foundation-japan.github.io/rfc6749.ja.html)は前述の通り、認可のための仕組みです。時々聞く「OAuth 認証」と言うのは誤りというか、区別せずに認証に OAuth を利用するとセキュリティーホールになってしまうので十分注意しましょう。
OAuth を安易に認証に利用した場合のリスクや攻撃については、多くの記事が存在するのでいくつか参考記事をリンクしておきます。これらの記事はちょっと長かったり難しかったりしますが、そもそも認証周りや攻撃はどう頑張っても難しいところなので何度も読んで理解するよう努めたいところです。

https://ritou.hatenablog.com/entry/2020/12/01/000000
https://atmarkit.itmedia.co.jp/ait/articles/1710/24/news011_2.html

### OAuth 認証の脆弱性

OAuth2.0 は IETF の RFC6749 で定義されている仕様です。前述の通り、OAuth は認可の仕組みであって認証の仕組みではありません。仕様的には OAuth は、アクセストークンというものを発行するための仕様です。アクセストークンを保持してる＝必ずしもリソースオーナーとは限りません。
具体的には(こちら記事)[https://atmarkit.itmedia.co.jp/ait/articles/1710/24/news011_2.html]にあるような脆弱性につながる可能性があります。長いので内容を簡単にまとめると以下のような攻撃とその対策が必要となります。

#### CSRF

**Cross-Site Request Forgery**という、有名な攻撃手法の一つです。CSRF というと攻撃者が被害者になりすまして SNS 投稿するなどのイメージが強かったのですが、OAuth の場合は逆に攻撃者のリソースアクセス権を被害者環境で有効にします。これにどんな意味があるかというと、鍵付きの SNS 投稿に添付された画像が攻撃者のリソースに意図せず連携してしまうなどが挙げられます。
これを防ぐには OAuth の state パラメータと呼ばれる Client のセッションに紐づく値を検証することで、認可を行ったユーザーとアクセストークンを取得しようとしているユーザーが一致していることを保証されます。

#### リプレイ攻撃

TBW

#### トークン置き換え攻撃

TBW

### Open ID Connect

Open ID Connect は OAuth2.0 を拡張した、認証のための仕様です。ユーザー自身の身分証明と同時に、一般的に利用されるようなプロフィール情報の取得までが定義されています。また、認証周りの攻撃対策に利用されるような検証すべき情報も取得できます。重要なのは、この検証すべき情報というのはよしなにやってくれるわけではないので、クライアント（RP）側で検証処理を実際に行わなければいけないことです。
本稿は Next.js を想定してますが、Next.js の場合は API 側でこの検証を行ったほうが良いかと思われます。

### ID トークンから取得できるもの

ID トークンから取得できるものを簡単に説明したものを以下に示します。詳細は(仕様書に定義)[http://openid-foundation-japan.github.io/openid-connect-core-1_0.ja.html#IDToken]を参照してください。

| 項目名    | 必須・非必須   | 説明                                                                                                                                                      |
| --------- | -------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------- |
| iss       | 必須           | トークンの発行者（＝ issuer）を表す URL。                                                                                                                 |
| sub       | 必須           | クライアントが利用可能なユーザーの識別子。`24400320` や `AItOawmwtWwcT0k51BayewNvutrJUqsvl6qs7A4`のような文字列。                                         |
| aud       | 必須           | OAuth2.0 のクライアント ID。ID トークンが誰に向けたものかを表しており、これを検証することで別クライアント向けに発行されたトークンでないことを保証できる。 |
| exp       | 必須           | ID トークンの有効期限。                                                                                                                                   |
| iat       | 必須           | ID トークンの発行日時。                                                                                                                                   |
| auth_time | リクエスト次第 | 認証が発生した時刻。`max_age`がリクエストに含まれている場合、この項目は必須。                                                                             |
| nonce     | リクエスト次第 | リクエストに`nonce`が含まれていた場合、そのままこの項目に格納される。クライアント側でこの項目を検証することでリプレイ攻撃を防ぐのに利用する。             |
| acr       | 非必須         | `認証コンテキスト`と呼ばれる文字列が格納され、パスワード認証以上のものを行なったかどうかなどの認証レベルを表す。                                          |
| amr       | 非必須         | 認証手法を表す文字列。具体的な仕様については利実装者間で取り決めることとされている。                                                                      |
| azp       | 非必須         | ID トークンの発行を要望したクライアントと実際に利用するクライアントが異なる場合にこの項目が利用される。クライアント ID が格納されている。                 |

### ID トークンの検証要件

TBW

#### nonce 検証（リプレイ攻撃対策）

リクエスト時に`nonce`にユーザーのクライアントセッション値由来のハッシュ値を付与し、クライアント側でセッションから再度ハッシュ値生成し検証することでクライアントセッションと ID トークンを紐づけることでリプレイ攻撃を防ぐのに利用する。

## 構成メモ

- introduction
  - Next と認証のメモだよ
- 認証と認可
  - 認証と認可
  - OAuth2
  - OAuth 認証の脆弱性
    - CSRF
    - リプレイ攻撃
- Open ID Connect
  - Open ID Connect(OIDC) とは
  - ID トークンから取得できるもの
  - ID トークンの検証要件
    - nonce の検証など
  - cookie に格納する際の設定
    - http only
    - secure
    - same site
- 実際の実装要件
  - 処理フロー
    - （図）
    - API へアクセス
    - 認証が完了時
      - ユーザー ID をセッション Cookie で紐付け
    - 次回からログイン情報取れる
  - cookie
    - http only
    - same site
    - secure

TODO

- 図の追加
- 仕様を一旦全部読んでみる
