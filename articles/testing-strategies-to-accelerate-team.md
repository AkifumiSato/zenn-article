---
title: "チーム開発を加速するテストの育て方"
emoji: "⛳"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["test", "jest"]
published: false
---

テストを書いてないというチームには色々理由があると思いますが、「何をテストすべきかわからない」「書き方がわからない」「どのくらいメリットがあるかわからない」という意見は多いのではないでしょうか？テスティングフレームワークの選定や使い方を学ぶのは重要ですが、それ以上に**テストの目的や戦略を学ぶことが重要**です。識者たちの説くテストの目的を学び、アプリケーションに合った戦略を立てられなければ、テストは形骸化するかプロジェクトの足を引っ張るだけになります。特にチーム開発においてテストを活かすのは相応の知識とスキルが必要になりますが、活かせればテストは開発スピードを維持・促進する飛び道具になり得ます。

本稿は筆者が取り組んで実際に高いチーム満足度と速度を得られた、テスト戦略についてまとめたものです。

:::message
- 筆者は[単体テストの考え方/使い方](https://book.mynavi.jp/ec/products/detail/id=134252)という書籍で学んだことに大きく影響されています。興味のある方はぜひこの書籍や、筆者の過去の記事[フロントエンドにおける「単体テストの考え方/使い方」](https://zenn.dev/akfm/articles/frontend-unit-testing)」を参照ください。
- 主にチーム開発におけるテストの考え方や戦略の話になりますが、筆者の特性上、Webアプリやフロントエンドを前提とした部分もあります。
:::

## テストの目的

新規開発か運用か、開発規模の大小など様々あれど、ビジネスにおいて開発速度というのは常に求められるものです。多くのWebアプリケーションは作って終わりではなく、その後も機能追加や修正などさまざまな運用をし続けることになります。初期開発においても、仕様変更・追加要件・バグ修正はほぼ確実に発生します。このような多くの変更に耐えうる**変更容易性**が中長期のみならず短期的にも必要になってきます。変更容易性を損なうと、開発プロジェクトはたちまち遅延しはじめることでしょう。

テストはプロダクションコードの変更によって起こる**リグレッション**（退行、予期せぬ変更）を検知することが可能です。プロダクションコードの変更が与えた影響が実装者以外にも明確になるので、調査や考慮漏れに伴う工数が削減されます。また、予期せぬ変更も明確になるのでバグ対応工数も削減できます。これらの削減される工数を、消して軽んじてはいけません。これらが原因で遅れた開発プロジェクトは非常に多く存在します。

**開発速度を維持すること**、そして開発速度を悪化させうる**リグレッションを防ぐこと**こそが、テストを書く大きなモチベーションです。

### テストを書くことは目的ではない

よくあるアンチパターンですが、テストを書くことが目的になってしまうことがあります。「テストを書くといいらしい、だからテストを書こう」と言ったものです。テストを書くことは目的ではありません。テストを書くことは、目的を達成するための手段の一つです。カバレッジを無理に100%にしてリグレッション検知の役には立たないようなテストを書いてしまってたり、書き方に悩んで時間を使いすぎて開発速度を損なうようなら、目的に反しています。

リグレッション検知に役立たないテストは避けるべきですし、書き方やテスティングフレームワークの使い方に悩むのならば有識者やチームメンバーにまずは相談すべきです。あまりに時間がかかるようなら、時には諦めることも重要です。

### テストが効果的なプロジェクト

テストの目的を意識すると、テストが効果的な場合とそうでない場合があることに気づけます。フロントエンドで言うと、振る舞いのほぼないランディングページを量産するプロジェクトにおいては単体テスト（定義は後述）を書いてもあまり役に立たないかもしれませんが、Visual Regression Testing（VRT）は大いに役立つことでしょう。一方でいわゆるWebアプリケーションとよばれるものの多くでは、単体テストもVRTは非常に有用になり得ますが、E2Eテストに注力しすぎると膨大な工数を消費することになるでしょう。

## テスト運用の課題と対策

目的を意識できても、目的を達成するようなテスト運用をすることは難しいことです。筆者がチームで運用する上で、特に対策が必要と考えた点は以下の4点です。

- テスティングフレームワーク
- テスト設計
- 設計・書き方などのチーム内統一
- ドキュメント

### テスティングフレームワーク

チームで運用する以上、1人以上テスティングフレームワーク自体の使い方や環境構築についてリードできるエンジニアが必要になります。テストの導入を考えているが自信がないという方は、公式ドキュメントをしっかり読みこみ、ある程度使い方や環境構築については習得しておく必要があります。

フロントエンドの単体テストの場合は、jestかvitestを選ぶのが無難でしょう。

https://jestjs.io/ja/

https://vitest.dev/

### テスト設計

テスト設計は目的である開発速度を維持することやリグレッションを防ぐことために、最も重要なスキルです。どのテストでどこまで担保し、何をしないのか、何をモックにするのか、テスト粒度はどうやって揃えるのか、など考えることは多岐にわたります。幸い、これらの観点については書籍などから体系的に学ぶことが可能です。以下はテスト設計について学ぶにあたり、筆者がお勧めしたい書籍です。

- [単体テストの考え方/使い方](https://book.mynavi.jp/ec/products/detail/id=134252)
- [テスト駆動開発](https://shop.ohmsha.co.jp/shopdetail/000000004967/)
- [Clean Craftsmanship](https://tatsu-zine.com/books/clean-craftsmanship)
- [フロントエンド開発のためのテスト入門](https://www.shoeisha.co.jp/book/detail/9784798178189)

上記はどれもお勧めですが、どれをお勧めするかはその人の置かれた状況やスキルによります。ぜひご自分で内容を精査し、自分にあった本を選んでみてください。

### 設計・書き方などのチーム内統一

少数のリードするエンジニアが設計や書き方を学んでも、これらをチームで運用するには全員が一定以上の理解度やスキルを習得する必要があります。テストに限らず、チームに設計や書き方を共有することはそれ自体が難しいことです。

筆者は[モブプログラミング](https://engineering.mercari.com/blog/entry/20211130-52e6d96087/)（もしくはペアプログラミング）でこれらの課題を解決してきた経験が多いので、これを推奨します。モブプログラミングではお互いに苦手領域をフォローしあったり、観点漏れをリアルタイムに指摘しあえます。

:::details モブプログラミングと効率
時折これらに対し、「効率が悪い」という指摘を耳にすることがありますが、これは[リソース効率とフロー効率](https://qiita.com/hirokidaichi/items/f59e611772c02f2e74ee)どちらで考えるか次第です。実際昨今の研究では、フロー効率の指標であるリードタイムは[最も重要な開発速度の指標の1つ](https://cloud.google.com/blog/ja/products/gcp/using-the-four-keys-to-measure-your-devops-performance)に数えられています。
:::

### ドキュメント

テストを運用する上で、目的・設計・サンプルなどが記載されたドキュメントを用意していつでも見返せるようにしておくことはとても重要です。ドキュメントはチームにおける合意形成にもなりますし、迷った時の道標にもなります。

一方で、用意したドキュメントに対し以下のような経験もしくはフィードバックを受けた方は多いのではないでしょうか？少なくとも筆者はどれも大いに心当たりがあります。

- 読んでない
- 読んだが理解できない
- 理解できたが使えない
- 使えるけど応用はできない

テストのドキュメントには前述の通り目的・設計・サンプルなどの最も重要なことのみを記載し、さらにこれを口頭でも共有することで、少なくとも上記の「理解できた」までは目指せると思います。

## テストを運用するまでの段取り

TBW: 実際のstepを書いて、各詳細を記述

----以下見直し----

## テスト戦略

テストにはさまざまな粒度が存在し、しかもその定義はさまざまな解釈が存在します。単体テストにおける「**古典学派**」「**ロンドン学派**」はテストにおける解釈が別れてる代表例です。以下は筆者の[過去の記事](https://zenn.dev/akfm/articles/frontend-unit-testing#%E3%80%8C%E5%8D%98%E4%BD%93%E3%80%8D%E3%81%AE%E5%AE%9A%E7%BE%A9)からの引用です。

| 名称         | 単体の捉え方                                                     |
|------------|------------------------------------------------------------| 
| **ロンドン学派** | 1単位のコード（例: 1クラス）を単体と捉え、他の単体（クラス）はテストダブルに置き換える。モック主義とも呼ばれる。 |
| **古典学派**   | テストケースを単体として捉え、他のテストケースに影響しうる共有依存のみをテストダブルに置き換える。          |

一方で共通認識とされているのが、より上位のテストであるE2Eなどはリグレッション検知における忠実性は高いがコストも高く、速度・安定性に欠けるという点です。この点から考えられた粒度ごとの最適なバランスの図として有名なのが[テストピラミッド](https://gihyo.jp/dev/serial/01/savanna-letter/0005)や[テスティングトロフィー](https://kentcdodds.com/blog/the-testing-trophy-and-testing-classifications)です。

_テストピラミッド（抜粋）_
![テストピラミッド](/images/testing-strategies-to-accelerate-team/pyramid.png)

_テスティングトロフィー（抜粋）_
![テスティングトロフィー](/images/testing-strategies-to-accelerate-team/torophy.png)

前述の通り、テストの最大の目的は開発速度の維持です。筆者の場合担当していたのがフロントエンド開発だったので、後者のテストピラミッドの方が適してると判断し、中間レベルに該当する部分であるデータ接続を伴うコンポーネントや処理に対しては厚くテストし、低レベルなコンポーネントのテストや高レベルなE2Eテストは薄くテストしていくこととしました。

### テスト粒度の定義

中間レベルのテストを多めにしていきたいわけですが、各テスト粒度の定義も人によりけりです。前述の[テストピラミッド](https://gihyo.jp/dev/serial/01/savanna-letter/0005)の記事には、最も有名なプログラマーの1人であるマーティン ・ファウラーの引用が載っています。

> “in the first morning of my training course I cover 24 different definitions of unit test”.
> “トレーニング コースの最初の朝、私は単体テストの 24 の異なる定義をカバーしました。“

それほどに「単体テスト」の指す言葉の定義は人によりけりで、異なります。少しフロントエンドの話になりますが、APIなどの外部システムとの「統合」があればインテグレーションテストと呼ぶ人もいるし、上記の記事のように複数のモジュールからなるもののテストをインテグレーションテストと呼ぶ人もいます。単体テストの考え方/使い方では、「単一プロセスで実行可能なテスト」のことを単体テストと定義しています。

筆者はこれらの世間でも別れてる解釈についてどれを採用するか考えること以上に、storybookとjestそれぞれで何をやって何をやらないかを定義することの方が重要だと考えました。筆者は「単体テストの考え方/使い方」に沿ってjestで行ってる単一プロセスで実行可能なテストのことを単体テストと呼称していますが、どの考え方をもとに呼称を決めるかはプロジェクトやチームによってそれぞれで良いと考えます。呼称や定義の統一は重要ですが、世間的にさまざまな解釈がある以上プロジェクト内において統一できてれば十分です。

### E2Eについて

E2Eはリグレッション検知の効果は高いが壊れやすく、コストがかかるものです。そのため、テスト対象は特に重要機能に絞り、テストシナリオも慎重に精査する必要があります。

筆者の場合、関連するAPI開発チームも多くE2Eのシナリオ構築と運用には各種APIチームとの連携が不可欠だったため、より高コストなことが見込まれました。そのため、E2Eテストについては後追いで徐々に足していけるよう非常に少ないケースのみ作成し、環境＋サンプルを残して後追いで特に守りたい重要機能を見極めながら徐々に足していくこととしました。

## 単体テスト戦略

単体テストの定義は前述の通りで、筆者は単体テスト（storybook+jest）に注力することが費用対効果が高いと判断しました。しかし単体テストを実際に開発チームで運用するには前述の[#テストを運用する難しさ](#テストを運用する難しさ)で求められるスキルが求められます。

筆者は自身・チームのスキルを向上していくステップを以下のように計画しました。

todo: 以降書き直し

筆者は[単体テストの考え方/使い方](https://book.mynavi.jp/ec/products/detail/id=134252)を読んで、これをフロントエンドに適用するにあたり疑問点を識者に相談し、理解を深めました。得られた知識をチームに展開し、目的に沿ったテストを運用していきたいと思うと、先述の知識とスキルの共有の難しさが障壁になります。そこで、以下のstepでチームに展開していくことにしました。

- step0: 「[単体テストの考え方/使い方](https://book.mynavi.jp/ec/products/detail/id=134252)」を読む、識者に相談する
- **step1: ドキュメントの作成と共有**
- **step2: 参考になる例を実装する**
- **step3: 共有・相談・議論の場を整える**

これらについて実際にやったことを紹介します。

### step1: ドキュメントの作成と共有

まずは達成したいこと、悩みやすいポイント、サンプルをドキュメントに残します。ドキュメントはシンプルで読むのが辛くない量を目指さないと、読むハードルが上がってしまうので気をつけます。以下の記事はチーム向けの意味も込めて書いたのですが、長いのでこれをさらに要約します。

https://zenn.dev/akfm/articles/frontend-unit-testing

上記記事の内容に基づき、以下のような構成のマークダウンファイルを用意しました。見やすさ・わかりやすさのため部分的に修正・省略してます。

```markdown
## 単体テストの目的

Jest による単体テストを用いて、以下を達成することを目指す。

- リグレッション耐性: 修正による意図せぬデグレを防ぐ
- リファクタリング耐性: Flaky や壊れやすいテストを避ける
- 迅速なフィードバック: 高速なテスト実行
- テスト自体の保守性: テストコードの読みやすさ

## テスト観点

### コンポーネントのテスト観点
...

### 外部依存の取り扱い
...

### submit時の送信データの検証
...

## テストケースの記述

### コンポーネントのテスト
...

### テストフェーズの記載(AAAパターン)
...

### テストの共通化
...
```

長すぎないマークダウン1枚なら思い返したい時に読めるので、この量が適切と判断しました。ただ最初に読むきっかけがなければやはりドキュメントは読まれません。ということで、上記をほぼ読み上げるだけ＋QAの会議を設定し、口頭でもチームに上記ドキュメントを共有しました。ここで意見があれば議論し、取り込むことも重要です。

### step2: 参考になる例を実装する

TBW

### step3: 共有・相談・議論の場を整える

## 構成

- 結果
  - 実際この1年2チームで↑をやってみた
  - 個人的にはかなり効果を感じた
  - 筆者だけが感じてもしょうがないので、匿名アンケートで忌憚なき意見を募集してみた
    - テストのことに限らず、技術選定や進め方など多くの項目について聞いてみた
    - 全体的に耳が痛い話もあったし、それなりに本音で回答してもらえたと思う
  - その中でもテストについては、全体的にかなり好評だった
    - チーム満足度が高かった
    - 「テストに助けられた」「苦手意識がなくなった」「目的がはっきりして迷わなくなった」「見通しがよくなった」「手戻りが減った」「テストの分量がちょうどよかった」etc...
    - ネガティブな意見はなかった（！）
  - 筆者・チーム共に、単体テストの目的は達成できていることを実感している
  - また予期せぬ効果として、エラー時のUI実装漏れがかなり減った
    - テスト観点を考える時に、エラー時テストをよく書くために実装漏れがかなり減った
    - 手戻り観点で開発スピードには大きく貢献したように感じる
- まとめ
  - 目的の達成により、以下のような効果が得られたと考えられる
    - チームの開発体験の満足度向上
      - 開発体験の満足度が高い≒効率的・生産的な開発が実現できている
    - チームの開発スピード向上
      - 遅延リスク回避
      - 初期から一定の速度で開発し続けられていることから、プロジェクト全体で見ても早まったのでは？
        - 定量的なエビデンスは当然ないので、定性評価
          - （そもそも定量的に測るには全く同じスキルセットを持ったメンバー複数チームで同時に同じプロジェクトをやらないとわからない）
          - そこらへんの統計的データが気になる方はLeanとDevopsの科学を参照されたし
  - 一方、細かい点ではまだブラッシュアップの余地があるとも感じてる
    - プロジェクト規模にもよるし、チームメンバーのスキルにもよるので、まだまだ一概には言えない部分が多い
  - 今後も同様の活動を続けて、より良いテストの文化を多くのチームに根付かせていきたい
