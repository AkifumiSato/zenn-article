---
title: "小さいREST API設計"
---

## 要約

バックエンドのAPIは小さく細かいリソース単位のREST APIに設計しましょう。

:::message
このchapterの主題は「App Routerが利用するバックエンドAPIの設計」の話です。App Routerにおける[Route Handler](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)の話題ではないのでご注意ください。
:::

## 背景

昨今のバックエンドAPI開発において、最もよく用いられる設計は[REST API](https://learn.microsoft.com/ja-jp/azure/architecture/best-practices/api-design)です。しかし、REST APIの設計においてリソース単位をどう設計するかは経験とスキルを必要とする、難しい問題です。

### リソース単位の粒度とトレードオフ

REST APIにおいてはリソース単位を細かくすることが基本ですが、細かくしすぎるといわゆるおしゃべりなAPI(Chatty API)になり、アンチパターンとされています。`/users/[id]/username`のように、User情報の細かい単位でAPIエンドポイントが設定されてたら利用者側の実装が必要以上に冗長になってしまうことが想像できます。

一方でリソース単位を非正規化し大きくすると通信回数を減らすことができますが、大きすぎると汎用性を失い、必要以上にデータを取得してしまうことによるパフォーマンス劣化など様々な問題を引き起こします。`/users/1`で常にUserが執筆したブログ記事一覧やそのコメントまで取れてしまったら明らかにtoo muchです。

小さすぎも大きすぎもしない適度なバランスをとることが重要で、そこに経験とスキルが求められます。

### 粒度のバランスとPages Routerにおける傾向

アプリケーションのバックエンドAPIの設計時には、利用者側であるフロントエンド都合を考慮することが多いでしょう。

ことNext.jsのPages Routerにおいては、[getServerSideProps](https://nextjs.org/docs/pages/building-your-application/data-fetching/get-server-side-props)などページの外で一度にデータ取得を行う必要があるため、データ取得と参照が遠く、細かいリソース単位だと**実装が冗長・煩雑になってしまう**傾向がありました。そのためPages RouterにおいてはバックエンドAPIのリソース単位は、ページ単位などある程度大きく設計する方がフロントエンド側の実装が楽になる傾向がありました。

## 設計・プラクティス

App RouterにおいてはServer Componentsによってデータフェッチのコロケーションや分割が容易に可能になったため、データ取得とデータ参照のコードが近くなり、コードやロジックの重複が発生しづらくなりました。このため、App Routerは**細かいリソース単位で設計されたREST APIと非常に相性が良い**と言えます。

バックエンドAPIの設計観点から言ってもリソース単位で設計されたREST APIの実装はシンプルに実装できることが多く、メリットとなるはずです。

## トレードオフ

### バックエンドとの通信回数

[データフェッチ on Server Components](part_1_server_components)でも述べた通り、通常BFFとAPIサーバー間の通信は多くの場合高速で安定しています。そのため通信回数が多いことはデメリットになりづらいと言えますが、アプリケーション特性にもよるので実際には注意が必要です。

過剰に分割されたAPIに対しウォーターフォールが多数発生すると、パフォーマンスボトルネックになる可能性があるので、注意しましょう。

### バックエンドAPI開発チームの理解

バックエンドAPIには複数の利用者がいる場合もあるため、Next.jsが小さいAPIの方が都合がいいならそうしましょうと一存で決めれるとは限りません。バックエンド開発チームの経験則や価値観もあります。

しかし、小さいAPIにすることはフロントエンド開発チームにとってもバックエンド開発チームにとってもメリットが大きく、無碍にできない要素です。最終的な判断がバックエンド開発チームにあるとしても、しっかりメリットやNext.js側の背景を伝え理解を得るべく努力しましょう。
