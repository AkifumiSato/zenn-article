---
title: "細かいリソース単位のREST API設計"
---

## 要約

バックエンドのAPIは細かいリソース単位のREST APIに設計しましょう。

:::message
このchapterの主題は「App Routerが利用するバックエンドAPIの設計」の話です。App Routerにおける[Route Handler](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)の話題ではないのでご注意ください。
:::

## 背景

昨今のバックエンドAPI開発において、最もよく用いられる設計は[REST API](https://learn.microsoft.com/ja-jp/azure/architecture/best-practices/api-design)です。しかし、REST APIの設計においてリソース単位をどう設計するかは経験とスキルを必要とする、難しい問題です。

### リソース単位の粒度とトレードオフ

REST APIにおいてはリソース単位を細かくすることが基本ですが、細かくしすぎるといわゆるおしゃべりなAPI(Chatty API)になり、アンチパターンとされています。`/users/[id]/username`のように、User情報の細かい単位でAPIエンドポイントが設定されてたら使いづらいであろうことが想像できます。

一方で非正規化し大きくすると通信回数を減らすことができますが、大きすぎると汎用性を失い、参照しないデータ取得のためにパフォーマンス劣化するなど様々な問題を引き起こします。`/users/1`でUserの所属する会社情報やグループ会社情報まで取れてしまったら、データの取得コストが高くなることは想像できます。

これらのトレードオフのバランスをとることが重要で、そこに経験とスキルが求められます。

### 粒度のバランスとPages Routerにおける傾向

アプリケーションのバックエンドAPIの場合、これらのバランスを考える際には利用者側であるフロントエンド都合を考慮することが多いでしょう。

ことNext.jsのPages Routerにおいては、[getServerSideProps](https://nextjs.org/docs/pages/building-your-application/data-fetching/get-server-side-props)などページの外で一度にデータ取得を行う必要があるため、データ取得と参照が遠く、細かいリソース単位だと**実装が冗長・煩雑になってしまう**傾向がありました。そのためPages RouterにおいてはバックエンドAPIのリソース単位は、ページ単位などある程度大きく設計する方がフロントエンド側の実装が楽になる傾向がありました。

## 設計・プラクティス

App RouterにおいてはServer Componentsによってデータフェッチのコロケーションや分割が容易に可能になったため、データ取得とデータ参照のコードが近くなり、コードやロジックの重複が発生しづらくなりました。このため、App Routerは**細かいリソース単位で設計されたREST APIと非常に相性が良い**と言えます。

バックエンドAPIの設計観点から言ってもリソース単位で設計されたREST APIの実装はシンプルに実装できることが多く、メリットとなるはずです。

## トレードオフ

### バックエンドとの通信回数

[データフェッチ on Server Components](part_1_server_components)でも述べた通り、通常BFFとAPIサーバー間の通信は多くの場合高速で安定しています。そのため通信回数が多いことはデメリットになりづらいと言えますが、アプリケーション特性にもよるので実際には注意が必要です。

過剰に分割されたAPIに対しウォーターフォールが多数発生すると、パフォーマンスボトルネックになる可能性があるので、注意しましょう。

### バックエンドAPI開発チームの理解

バックエンドAPIの設計は、利用するフロントエンド開発チームが主導することもあればバックエンド開発チームが主導することもあります。この点は会社や組織によってまちまちでしょう。注意しなければならないのは、バックエンド開発チームが主導し、かつ「大きなAPI」設計になってしまった場合です。

前述の通り、「小さなAPI」にすることはフロントエンド開発チームにとってもバックエンド開発チームにとってもメリットが大きいです。しかし、これまでの開発経験が「大きなAPI」の方が慣れ親しんでるバックエンド開発チームは、自然と「大きなAPI」設計を採用してしまうこともあるでしょう。

この場合、フロントエンド開発チームがNext.js側の考慮や、「小さなAPI」のメリットをバックエンド開発チームに理解してもらうべく説明する必要があるでしょう。自ら設計を主導する立場にない場合、説明を理解してもらう難易度・コストは大きくなります。

しかし、フロントエンド側の都合を無考慮で「大きなAPI」設計になってしまうと、Next.js側の設計上大きな制約になってしまいます。双方に大きなメリットがあるということを、懇切丁寧に説明し、理解を得ましょう。
